# orbinum-zk-circuits

[![crates.io](https://img.shields.io/crates/v/orbinum-zk-circuits.svg)](https://crates.io/crates/orbinum-zk-circuits)
[![Documentation](https://docs.rs/orbinum-zk-circuits/badge.svg)](https://docs.rs/orbinum-zk-circuits)

R1CS circuits and constraint gadgets for off-chain ZK proof generation.

## Features

- **Arkworks gadgets**: Poseidon, Merkle, commitment, nullifier circuits
- **Type-safe constraints**: Compile-time validation of circuit logic
- **Compatible**: Works with circom, SnarkJS toolchain
- **BN254 curve**: Same as Ethereum's alt_bn128
- **32 tests**: Full circuit validation suite

## Installation

```toml
[dependencies]
orbinum-zk-circuits = "0.2"
ark-r1cs-std = "0.4"
ark-bn254 = "0.4"
orbinum-zk-core = "0.2"  # For native crypto validation
```

## Usage

### Generate Transfer Proof (Private Transaction)

```rust
use orbinum_zk_circuits::application::{
    use_cases::TransferCircuit,
    dto::{TransferWitness, TransferPublicInputs, MerklePath},
};
use ark_bn254::{Bn254, Fr};
use ark_groth16::Groth16;
use ark_snark::SNARK;

// Create circuit with witness data
let witness = TransferWitness {
    input_note_value: Fr::from(1000u64),
    input_note_asset_id: Fr::from(1u64),
    input_note_owner: Fr::from(12345u64),
    input_note_blinding: Fr::from(67890u64),
    merkle_path: MerklePath::new(vec![
        Fr::from(0), Fr::from(1), // ... siblings
    ]),
    leaf_index: 5,
    spending_key: Fr::from(999u64),
    output_note_value: Fr::from(800u64),
    output_note_recipient: Fr::from(54321u64),
    output_note_blinding: Fr::from(11111u64),
};

let public_inputs = TransferPublicInputs {
    merkle_root: Fr::from(123),
    nullifier: Fr::from(456),
    output_commitment: Fr::from(789),
};

let circuit = TransferCircuit::new(witness, public_inputs);

// Generate proof (requires trusted setup from artifacts/)
let (pk, vk) = setup::<Bn254, _, _>(&circuit, &mut rng);
let proof = Groth16::<Bn254>::prove(&pk, circuit, &mut rng)?;
```

### Generate Unshield Proof (Withdraw)

```rust
use orbinum_zk_circuits::application::{
    use_cases::UnshieldCircuit,
    dto::{UnshieldWitness, UnshieldPublicInputs},
};

let witness = UnshieldWitness {
    note_value: Fr::from(500u64),
    note_asset_id: Fr::from(1u64),
    note_owner: Fr::from(12345u64),
    note_blinding: Fr::from(67890u64),
    merkle_path: MerklePath::new(siblings),
    leaf_index: 3,
    spending_key: Fr::from(999u64),
};

let public_inputs = UnshieldPublicInputs {
    merkle_root: Fr::from(123),
    nullifier: Fr::from(456),
    recipient: Fr::from(99999u64),  // Public destination account
    amount: Fr::from(500u64),
    asset_id: Fr::from(1u64),
};

let circuit = UnshieldCircuit::new(witness, public_inputs);
let proof = Groth16::<Bn254>::prove(&pk, circuit, &mut rng)?;
```

### Validate Circuit Constraints

```rust
use ark_relations::r1cs::ConstraintSystem;

let cs = ConstraintSystem::<Fr>::new_ref();
circuit.generate_constraints(cs.clone())?;

assert!(cs.is_satisfied().unwrap(), "Circuit constraints failed!");
println!("Constraints: {}", cs.num_constraints());
```

## Supported Circuits

| Circuit | Purpose | Public Inputs | Private Inputs |
|---------|---------|---------------|----------------|
| **TransferCircuit** | Private transfer | merkle_root, nullifier, output_commitment | input_note, spending_key, merkle_path, output_note |
| **UnshieldCircuit** | Withdraw to public | merkle_root, nullifier, recipient, amount, asset_id | note, spending_key, merkle_path |
| **DisclosureCircuit** | Prove ownership | commitment, owner_pubkey | note (value, asset_id, blinding) |

## Performance

| Operation | Constraints | Prove Time | Verify Time |
|-----------|-------------|------------|-------------|
| Transfer | ~4,200 | 300ms | 2ms |
| Unshield | ~3,800 | 280ms | 2ms |
| Disclosure | ~1,500 | 120ms | 2ms |

*Measured on Apple M1, BN254 curve, Groth16*

## Key Concepts

- **R1CS**: Rank-1 Constraint System (a Ã— b = c format)
- **Witness**: Private circuit inputs (not revealed in proof)
- **Public Inputs**: Values exposed in the proof
- **Gadget**: Reusable constraint generator
- **ConstraintSystem**: Accumulates R1CS equations

## Integration with Toolchain

Compatible with circom circuits in `/circuits`:
- Use circom for rapid prototyping
- Use this crate for Rust-native proof generation
- Same BN254 curve, same verification keys
- Can verify proofs generated by either toolchain

## License

Licensed under either of [Apache License, Version 2.0](LICENSE-APACHE2) or [GPL v3](LICENSE-GPL3) at your option.
